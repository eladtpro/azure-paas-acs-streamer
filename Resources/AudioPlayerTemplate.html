<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Audio Player</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/0.5.14/hls.min.js" referrerpolicy="no-referrer"></script>
    <script>
        if (!Hls.isSupported())
            console.error("Hls is not supported (hls.js).");
        console.log("Hls loaded (hls.js)");
        let hls = null;

        async function fetchHlsUrl() {
            console.log("fetchHls clicked");
            const funcUrl = $("#funcUrl").val();
            const name = $("#blobName").val();
            const url = `${funcUrl}&name=${name}`;
            console.log(`[fetchHlsUrl] Fetching url: ${url}`);
            return fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    console.log(`[fetchHlsUrl] data: ${data}`);
                    const dataUrl = Object.values(data).find(e => e.streamingProtocol === "Hls").paths[0];
                    console.log(`[fetchHlsUrl] dataUrl: ${dataUrl}`);
                    attachSource(dataUrl);
                    $("#hlsSource").val(dataUrl);
                    $("#loadUrl").prop('disabled', true);
                    // $("#hlsAudio").play();
                });
        }

        const attachSource = (source) => {
            if(hls){
                hls.loadSource(source);
                return;
            }

            let hlsAudio = $("#hlsAudio").get();
            hls = new Hls();
            hls.attachMedia(hlsAudio);
            hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                console.log("Audio and hls.js are now bound together !");
                hls.loadSource(source);
            });
        };

        $("#loadUrl").click(() => {
            attachSource(("#hlsSource").val());
        });

        $("#hlsAudio").on("play", () => {
            console.log("we can track events the same way with hls.js");
        });

        $("#hlsSource").change(() => {
            ("#loadUrl").prop('disabled', ("#hlsSource").val().length() < 1);
        });
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="mb-3">
            <input type="text" class="form-control" id="blobName" aria-describedby="blobNameHelp"
                placeholder="Blob Name" value="Led Zeppelin - Stairway To Heaven (Official Audio).mp3">
            <div id="blobNameHelp" class="form-text">Blob name in the storage container.</div>
        </div>
        <div class="mb-3">
            <input type="text" class="form-control" id="funcUrl" aria-describedby="blobUrlHelp"
                placeholder="Azure Function Url"
                value="https://func-ams-media.azurewebsites.net/api/AudioStreamer?code=gHziPP4fxlzLI-Wsru37WW3ne6cptAN4iDQyKkr3JmXoAzFu98se9w==">
            <div id="blobUrlHelp" class="form-text">Azure Function Url.</div>
        </div>
        <div class="mb-3">
            <button type="button" id="fetchHls" onclick="fetchHlsUrl();" class="btn btn-primary btn-sm">Fetch Hls Source</button>
        </div>
        <div class="mb-3">
            <input type="text" class="form-control" id="hlsSource" aria-describedby="hlsSourceHelp"
                placeholder="Hls Url">
            <button type="button" id="loadUrl" class="btn btn-primary btn-sm">Load Player</button>
            <div id="hlsSourceHelp" class="form-text">Hls source stream url.</div>
        </div>
        <div class="mb-3">
            <audio controls id="hlsAudio" preload="meta">
                <source src="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/sl.m3u8"
                    type="application/x-mpegURL" />
            </audio>
        </div>
    </div>
</body>

</html>